import delay from"./utils/delay.js";import stringDecoder from"./utils/string-decoder.js";const ObservableSlim=function(){let e=[],t=[],r=[],n=null,o=function(l,f,i,a){let u=null==f,c=i||null,s=a||"",p=[],g=function(e,t){return e instanceof Array?""!==s?s:t:""!==s?s+"."+t:t},h=0,y=function(e){if(!0!==c.paused)if(u&&(f=++h>1,delay((function(){h=0}))),!0===f)delay((function(){if(e===p.length){for(let e=0;e<c.observers.length;e++)c.observers[e](p);p=[]}}));else{for(let e=0;e<c.observers.length;e++)c.observers[e](p);p=[]}},b={get:function(e,t){if("__getTarget"===t)return e;if("__isProxy"===t)return!0;if("__getParent"===t)return function(t){void 0===t&&(t=1);let r=g(e,"__getParent").split(".");return r.splice(-(t+1),t+1),function(e,t){return t.split(".").reduce((function(e,t){return e?e[t]:void 0}),e||self)}(c.parentProxy,r.join("."))};if("__getPath"===t){return g(e,"__getParent").slice(0,-12)}let r=e[t];if(e instanceof Date&&r instanceof Function)return r.bind(e);if(r instanceof Object&&e.hasOwnProperty(t)){!0===r.__isProxy&&(r=r.__getTarget);let e=-1,n=c.targets;for(let t=0,o=n.length;t<o;t++)if(r===n[t]){e=t;break}return e>-1?c.proxies[e]:o(r,f,c,""!==s?s+"."+t:t)}{let e=c.renderMode?stringDecoder.encode(r):r,n=c.manipulate;return"function"==typeof n&&(e=n(e,t,!0)),e}},deleteProperty:function(e,o){let l=!0;n===d&&(l=!1,n=null);let f=Object.assign({},e),i=g(e,o);if(!c.paused){if(p.push({type:"delete",target:e,property:o,newValue:null,previousValue:f[o],currentPath:i,proxy:d}),"function"==typeof c.beforeChange&&c.checkBeforeChange!==i){if(c.checkBeforeChange=i,!1===c.beforeChange(p))return c.checkBeforeChange="",!1}c.checkBeforeChange=""}if(!0===l){let l,f;for(l=0,f=t.length;l<f&&e!==t[l];l++);let i=r[l]||[],a=i.length;for(;a--;)i[a].proxy!==d&&(n=i[a].proxy,delete i[a].proxy[o]);delete e[o]}return y(p.length),!0},set:function(e,o,l,f){let i=!0;n===d&&(i=!1,n=null);let a=e[o];if(a!==l||!1===i){let u=typeof a,s=g(e,o),h="update";"undefined"===u&&(h="add");let b=c.manipulate;if("function"==typeof b&&(l=b(l,s,!1)),!c.paused){if(p.push({type:h,target:e,property:o,newValue:l,previousValue:f[o],currentPath:s,proxy:d}),"function"==typeof c.beforeChange&&c.checkBeforeChange!==s){if(c.checkBeforeChange=s,!1===c.beforeChange(p))return c.checkBeforeChange="",!1}c.checkBeforeChange=""}if(!0===i){let f,i;for(f=0,i=t.length;f<i&&e!==t[f];f++);let a=r[f];if(a)for(let e=0,t=a.length;e<t;e++)a[e].proxy!==d&&(n=a[e].proxy,a[e].proxy[o]=l);e[o]=l,l instanceof Object&&null!==l&&function e(t){let r=t.__getTarget,n=Object.keys(r);for(let o=0,l=n.length;o<l;o++){let l=n[o];r[l]instanceof Object&&null!==r[l]&&e(t[l])}}(d[o])}y(p.length)}return!0}},d=new Proxy(l,b);null===c?(c={parentTarget:l,domDelay:f,parentProxy:d,observers:[],targets:[l],proxies:[d],path:s},e.push(c)):(c.targets.push(l),c.proxies.push(d));let x={target:l,proxy:d,observable:c},_=-1;for(let e=0,r=t.length;e<r;e++)if(l===t[e]){_=e;break}return _>-1?r[_].push(x):(t.push(l),r.push([x])),d};return{create:function(e,t,r,n){!0===e.__isProxy&&(e=e.__getTarget);let l=o(e,t);return"function"==typeof r&&this.observe(l,r),function e(t){let r=t.__getTarget,o=Object.keys(r);for(let l=0,f=o.length;l<f;l++){let f=o[l];"function"==typeof n&&n(r,f),r[f]instanceof Object&&null!==r[f]&&e(t[f])}}(l),l},observe:function(t,r){let n=e.length;for(;n--;)if(e[n].parentProxy===t){e[n].observers.push(r);break}},remove:function(n){let o=null,l=!1,f=e.length;for(;f--;)if(e[f].parentProxy===n){o=e[f],l=!0;break}let i=r.length;for(;i--;){let e=r[i].length;for(;e--;)r[i][e].observable===o&&(r[i].splice(e,1),0===r[i].length&&(t[i]=null))}!0===l&&e.splice(f,1)},manipulate:function(t,r){if("function"!=typeof r)throw new Error("callback is required");let n=e.length,o=!1;for(;n--;)if(e[n].parentProxy===t){e[n].manipulate=r,o=!0;break}},beforeChange:function(t,r){if("function"!=typeof r)throw new Error("callback is required");let n=e.length,o=!1;for(;n--;)if(e[n].parentProxy===t){e[n].beforeChange=r,o=!0;break}},beginRender:function(t){let r=e.length,n=!1;for(;r--;)if(e[r].parentProxy===t){e[r].renderMode=!0,n=!0;break}},endRender:function(t){let r=e.length,n=!1;for(;r--;)if(e[r].parentProxy===t){e[r].renderMode=!1,n=!0;break}},pause:function(t){let r=e.length,n=!1;for(;r--;)if(e[r].parentProxy===t){e[r].paused=!0,n=!0;break}},resume:function(t){let r=e.length,n=!1;for(;r--;)if(e[r].parentProxy===t){e[r].paused=!1,n=!0;break}}}}();export default ObservableSlim;