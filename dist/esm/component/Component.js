import{REGEX}from"../constants.js";import observer from"./observer.js";import hooks from"./hooks.js";import{updateElement}from"../vdom/index.js";import drawDynamic from"./helpers/draw-dynamic.js";import proxy from"../proxy.js";import toInlineStyle from"../utils/to-inline-style.js";import queueReady from"./helpers/queue-ready.js";import queueDraw from"./helpers/queue-draw.js";import extendInstance from"./helpers/extend-instance.js";import removeAllAttributes from"../utils/remove-all-attributes.js";import h from"../vdom/h.js";import loadLocal from"./helpers/load-local.js";import localMixin from"./helpers/local-mixin.js";import{compile}from"../vdom/parser.js";import propsInit from"./helpers/props-init.js";import DOMManipulation from"./DOMManipulation.js";import directive from"../directives/index.js";import cloneObject from"../utils/clone-object.js";import toLiteralString from"../utils/to-literal-string.js";import delay from"../utils/delay.js";import makeSureAttach from"./make-sure-attach.js";import data from"../data.js";const update={updateElement:updateElement}.updateElement;class Component extends DOMManipulation{constructor(e){super(e),Object.defineProperty(this,"_isSubclass",{value:this.__proto__.constructor!==Component}),Object.defineProperty(this,"uId",{value:this.app.generateUId(),enumerable:!0}),Object.defineProperty(this,"h",{value:h.bind(this),enumerable:!1}),this._initRawProps(e),extendInstance(this,e.cmp.cfg),localMixin(this),loadLocal(this);!1!==hooks.callBeforeCreate(this)&&(observer.create(this,!0),queueReady.add(this),queueDraw.add(this),hooks.callCreate(this))}set props(e){"function"==typeof e&&(e=e()),this._rawProps=Object.assign({},e,this._opt?this._opt.props:{}),observer.create(this),directive.callAppComponentSetProps(this)}get props(){return this._props}loadProps(e){if("object"!=typeof e)throw new TypeError("Props must be an object");this._rawProps=Object.assign({},e),propsInit(this),observer.create(this),hooks.callLoadProps(this)}set config(e){if(!this._isSubclass)throw new Error("Config is allowed only for classes");if(this._configured)throw new Error("Already configured");if("object"!=typeof e)throw new TypeError("Config must be an object");directive.callAppComponentSetConfig(this,e),"object"==typeof e.mixin&&(this.mixin=e.mixin,localMixin(this)),"object"==typeof e.components&&(this.components=e.components,loadLocal(this)),"boolean"==typeof e.autoCreateChildren&&(this.autoCreateChildren=e.autoCreateChildren),"boolean"==typeof e.updateChildrenProps&&(this.updateChildrenProps=e.updateChildrenProps),this._configured=!0,hooks.callConfigCreate(this)}getHTMLElement(){return this._parentElement}beginSafeRender(){proxy.beginRender(this.props)}endSafeRender(){proxy.endRender(this.props)}each(e,t,o=!1){let r;return Array.isArray(e)&&(o&&this.beginSafeRender(),r=e.map(t),o&&this.endSafeRender()),r}toStyle(e,t=!0){return toInlineStyle(e,t)}render(e,t=[],o=!1){if(this._renderPause)return;this.beginSafeRender();const r=Object.keys(this.props),n=[this.h];for(let e=0;e<r.length;e++)n.push(this.props[r[e]]);const s=this.template.apply(this,n);this.endSafeRender();let i=s&&"object"==typeof s?s:compile(s,this);this.app.emit("draw",i,this._prev,this),queueDraw.emit(this,i,this._prev);const a=update(this._cfgRoot,i,this._prev,0,this,e);this._mainComponentByAppCreate||removeAllAttributes(this._cfgRoot,this.exposeAttributes),!this._rootElement&&a&&(this._rootElement=a,makeSureAttach(this._rootElement),this._parentElement=a.parentNode,this.__hasStyle&&(this._parentElement.dataset?this._parentElement.dataset.uid=this.uId:this._parentElement.firstElementChild.nextElementSibling.dataset.uid=this.uId)),this._prev=i,o||hooks.callAfterRender(this),drawDynamic(this)}renderPause(){this._renderPause=!0}renderResume(e=!0){this._renderPause=!1,e&&this.render()}prepareCommit(){proxy.pause(this.props),this.renderPause()}commit(){this.renderResume(),proxy.resume(this.props)}get isRenderPause(){return this._renderPause}mount(e,t={}){if(this._unmounted)return!1===hooks.callBeforeMount(this)||(this._unmountedPlaceholder.parentNode.replaceChild(this._unmountedParentNode,this._unmountedPlaceholder),this._unmounted=!1,this._unmountedParentNode=null,this._unmountedPlaceholder=null,hooks.callMount(this),Object.keys(this.children).forEach((e=>{this.children[e].mount()}))),this;if(e){let o=this._rootElement;return"string"==typeof t.selector?o=o.querySelector(t.selector):t.selector instanceof HTMLElement?o=t.selector:1!==this._rootElement.nodeType&&(o=this.getHTMLElement()),this._unmounted=!1,this._unmountedParentNode=null,this._unmountedPlaceholder=null,this.app.mount(e,o,this)}}unmount(e=!1,t,o){if(this.lockRemoveInstanceByCallback&&"function"==typeof this.lockRemoveInstanceByCallback)this.lockRemoveInstanceByCallback(this.unmount,e,t,o);else if(e||!Boolean(this._unmountedParentNode)&&this._rootElement&&this._rootElement.parentNode&&this._rootElement.parentNode.parentNode)return!1!==hooks.callBeforeUnmount(this)&&(this._unmountedParentNode=this._rootElement.parentNode,this._unmountedPlaceholder=document.createComment(Date.now().toString()),e?this._rootElement.parentNode&&this._rootElement.parentNode.parentNode.removeChild(this._rootElement.parentNode):this._rootElement.parentNode.parentNode.replaceChild(this._unmountedPlaceholder,this._unmountedParentNode),this._unmounted=!t,o||hooks.callUnmount(this),Object.keys(this.children).forEach((r=>{this.children[r].unmount(e,t,o)})),this)}destroy(e){if(this.lockRemoveInstanceByCallback&&"function"==typeof this.lockRemoveInstanceByCallback)this.lockRemoveInstanceByCallback(this.destroy,e);else if(!1!==this.unmount(e,!0)&&(e||this._rootElement&&!1!==hooks.callBeforeDestroy(this))){if(Object.keys(this.children).forEach((e=>{this.children[e].destroy()})),hooks.callDestroy(this),this.parent&&this.parent.children){for(let e in this.parent.children)this.parent.children.hasOwnProperty(e)&&this===this.parent.children[e]&&delete this.parent.children[e];if(this.parent.childrenByTag[this.tag]){let e=this.parent.childrenByTag[this.tag].indexOf(this);-1!==e&&this.parent.childrenByTag[this.tag].splice(e,1)}}return!0}}template(){return""}_initTemplate(opt){if("string"==typeof opt.cmp.cfg.template&&opt.app.cfg.enableExternalTemplate){let contentTpl=opt.cmp.cfg.template;REGEX.IS_ID_SELECTOR.test(contentTpl)?opt.cmp.cfg.template=function(){let contentStr=toLiteralString(document.querySelector(contentTpl).innerHTML);return eval("`"+contentStr+"`")}:opt.cmp.cfg.template=function(){return contentTpl=toLiteralString(contentTpl),eval("`"+contentTpl+"`")}}}_initRawProps(e){this._isSubclass?this._rawProps=Object.assign({},e.props):(this._rawProps=Object.assign({},"function"==typeof e.cmp.cfg.props?e.cmp.cfg.props():e.cmp.cfg.props,e.props),this._initTemplate(e)),Object.defineProperty(this,"_initialProps",{value:cloneObject(this._rawProps)})}getDozWebComponentById(e){return this.getWebComponentById(e)}getDozWebComponentByTag(e){return this.getWebComponentByTag(e)}getWebComponentById(e){return data.webComponents.ids[e]||null}getWebComponentByTag(e){return data.webComponents.tags[e]||null}_setProps(e){for(let t in e)e.hasOwnProperty(t)&&(this.props[t]=e[t])}setProps(e){this.prepareCommit(),this._setProps(e),this.commit()}setPropsAsync(e){delay((()=>this._setProps(e)))}}export default Component;export{Component as _Component};