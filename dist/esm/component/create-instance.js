import html from"../utils/html.js";import{COMPONENT_ROOT_INSTANCE,COMPONENT_INSTANCE,ALREADY_WALKED,REGEX}from"../constants.js";import collection from"../collection.js";import hooks from"./hooks.js";import{serializeProps}from"../vdom/parser.js";import hmr from"./helpers/hmr.js";import Component from"./Component.js";import propsInit from"./helpers/props-init.js";import delay from"../utils/delay.js";import directive from"../directives/index.js";import getComponentName from"./helpers/get-component-name.js";import makeSureAttach from"./make-sure-attach.js";function createInstance(e={}){if(!e.root)return;e.mountMainComponent||(e.template instanceof HTMLElement?e.template.parentNode||e.root.appendChild(e.template):"string"==typeof e.template&&(e.template=html.create(e.template),e.root.appendChild(e.template)));let t,o=null;const n=[];function p(m,r={}){for(;m;){if(makeSureAttach(m),m._dozAttach[ALREADY_WALKED]){m=m.nextElementSibling;continue}m._dozAttach[ALREADY_WALKED]=!0,directive.callAppWalkDOM(r,m),t=getComponentName(m),directive.callAppComponentAssignName(r,m,(e=>{t=e}));let i={};r.cmp&&r.cmp._components&&(i=r.cmp._components);const l=e.autoCmp||i[t]||e.app._components[t]||collection.getComponent(t);let c;if(l){if(r.cmp){const e=m.outerHTML;r.cmp.rawChildren.push(e)}if(r.cmp&&r.cmp.mounted){m=m.nextElementSibling;continue}if(r.cmp&&!1===r.cmp.autoCreateChildren){n.push(m),m=m.nextElementSibling;continue}const p=serializeProps(m),i={};let a;if("function"==typeof l.cfg){if(!REGEX.IS_CLASS.test(Function.prototype.toString.call(l.cfg))){const e=l.cfg;l.cfg=class extends Component{},l.cfg.prototype.template=e}a=new l.cfg({tag:l.tag||t,root:m,app:e.app,props:p,componentDirectives:i,parentCmp:r.cmp||e.parent})}else a=new Component({tag:l.tag||t,cmp:l,root:m,app:e.app,props:p,componentDirectives:i,parentCmp:r.cmp||e.parent});if(!a){m=m.nextElementSibling;continue}if(a.rawChildrenObject=m._dozAttach.elementChildren,"object"==typeof a.module&&hmr(a,a.module),propsInit(a),a.app.emit("componentPropsInit",a),!1!==hooks.callBeforeMount(a)){if(a._isRendered=!0,a.render(!0),o||(o=a),a._rootElement._dozAttach[COMPONENT_ROOT_INSTANCE]=a,a.getHTMLElement()._dozAttach[COMPONENT_INSTANCE]=a,a._defaultSlot&&a.getHTMLElement().firstElementChild){let e=document.createComment("slot");a.getHTMLElement().replaceChild(e,a.getHTMLElement().firstElementChild)}delay((()=>{a.render(!1,[],!0)})),hooks.callMount(a),hooks.callMountAsync(a)}if(c=a,r.cmp){let e=Object.keys(r.cmp.children).length++;directive.callAppComponentAssignIndex(a,e,(e=>{r.cmp.children[e]=a})),void 0===r.cmp.childrenByTag[a.tag]?r.cmp.childrenByTag[a.tag]=[a]:r.cmp.childrenByTag[a.tag].push(a)}e.autoCmp=null}m.hasChildNodes()&&p(m.firstElementChild,c?{cmp:c}:{cmp:r.cmp}),m=m.nextElementSibling}}if(e.mountMainComponent){let t=new e.component({cmp:e.component,root:e.root,app:e.app,props:{},componentDirectives:{},parentCmp:null});if(propsInit(t),t.app.emit("componentPropsInit",t),t._isRendered=!0,t._mainComponentByAppCreate=!0,t.render(!0),e.innerHTML){html.create(e.innerHTML,"div").childNodes.forEach((e=>{t.getHTMLElement().appendChild(e)}))}return p(t.getHTMLElement(),{cmp:t}),n.forEach((e=>e.remove())),hooks.callMount(t),hooks.callMountAsync(t),t}return p(e.template),n.forEach((e=>e.remove())),o}export default createInstance;