import{TAG}from"../constants.js";import camelToDash from"../utils/camel-to-dash.js";import deepCopy from"../utils/deep-copy.js";import{compile}from"./parser.js";import cacheStores from"./stores.js";const tagText=TAG.TEXT_NODE_PLACE,LESSER="<",GREATER=">",PLACEHOLDER_REGEX_GLOBAL=/e-0_(\d+)_0-e/g,PLACEHOLDER_REGEX=/e-0_(\d+)_0-e/;function placeholderIndex(e,t){if("string"!=typeof e)return e;if("e"===e[0]&&"-"===e[1]){let o=PLACEHOLDER_REGEX.exec(e);return o?"0"===o[1][0]&&o[1].length>=2?t[o[1].substr(1)]+"":t[o[1]]:e}return e.replace(PLACEHOLDER_REGEX_GLOBAL,((e,o)=>o?t[o]:e))}function generateItemKey(e){let t="";for(let o=0;o<e.length;o++)"function"!=typeof e[o]&&"object"!=typeof e[o]&&(t+=e[o]);return t}function fillCompiled(e,t,o,p){let n=Object.keys(e);for(let s=0;s<n.length;s++)if(e[n[s]]&&"object"==typeof e[n[s]])fillCompiled(e[n[s]],t,e,p);else{let a=placeholderIndex(e[n[s]],t);if("type"===n[s]&&"string"!=typeof a){let t=a||{},o=camelToDash(t.tag||t.name||TAG.ROOT);o=o.replace(/_+/,""),-1===o.indexOf("-")&&(o=`${o}-${o}`);let n=o+"-"+p.uId+"-"+p._localComponentLastId++;p._componentsMap.has(a)?n=p._componentsMap.get(a):p._componentsMap.set(a,n),void 0===p._components[n]&&(p._components[n]={tag:o,cfg:t}),void 0===p.app._components[n]&&(p.app._components[n]={tag:o,cfg:t}),a=o,e.props["data-attributeoriginaletagname"]=n}Array.isArray(a)&&"0"===n[s]?(o.children=a,a[0]&&void 0!==a[0].key&&(o.hasKeys=!0)):e[n[s]]=a}}export default function(e,...t){let o,p,n;this.app?(o=this.app.cacheStores.hCache,p=this.app.cacheStores.kCache,n=this.app.isWebComponent&&this._mainComponentByAppCreate):(o=cacheStores.hCache,p=cacheStores.kCache);let s,a=o.get(e);if(!a){a=e[0];let p=!1,s=!1,l=!1,r=t.length;for(let o=0;o<r;++o){let r=e[o],i=r.length,c=r[i-1];for(let e=0;e<i;e++)"<"===r[e]?p=!1:">"===r[e]&&(p=!0);r.indexOf("<style")>-1&&(s=!0,l=!0),r.indexOf("</style")>-1&&(s=!1),l&&n&&(a=a.replace(/<style>/,"<style data-is-webcomponent>")),s&&(p=!1,a=a.replace(/ scoped>/," data-scoped>")),p?"object"==typeof t[o]||"function"==typeof t[o]?a+=`e-0_${o}_0-e${e[o+1]}`:(""===t[o]&&(t[o]=" "),/<.*>/.test(t[o])?a+=`${t[o]}${e[o+1]}`:a+=`<${tagText}>e-0_0${o}_0-e</${tagText}>${e[o+1]}`):a+="/"===c?e[o+1]:`e-0_${o}_0-e${e[o+1]}`}a=a.trim(),o.set(e,a)}let l,r=compile(a);if(r.props.forceupdate&&o.delete(e),void 0===r.key&&void 0===r.props["item-list"]||(l=generateItemKey(t),s=l?o.get(l):void 0),s||(s=deepCopy(r),fillCompiled(s,t,null,this),l&&o.set(l,s)),void 0!==r.key){let e=p.get(s.key);e?p.set(s.key,{isChanged:l!==e.clonedKey,clonedKey:l,next:s,prev:e.next}):p.set(s.key,{isChanged:!0,clonedKey:l,next:s,prev:{}})}return s}