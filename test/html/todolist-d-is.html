<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="description" content="DOZ - vdom">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>Doz - vdom</title>
    <script src="../../dist/doz.js?58962584588580r5g9284oi092158"></script>
    <style>
        body {
            font-family: sans-serif;
            background: peachpuff;
        }

        .todo-input {
            margin-bottom: 10px;
        }

        .todo-input input[type=text] {
            font-size: 14px;
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #ccc;
        }

        .todo-input button {
            font-size: 14px;
            padding: 10px;
            border-radius: 5px;
            border: 0;
            background: coral;
            color: #fff;
        }

        .todo-item {
            padding: 10px;
            margin-bottom: 5px;
            background: bisque;
            border-radius: 5px;
        }

        .todo-item input[type=text]{
            padding: 0;
            margin: 0;
            background: #fff;
            border: none;
            font-size: inherit;
            font-weight: bold;
            outline: none;
        }

        .todo-item:hover {
            background: #feffb3;
        }

        .todo-item.done {
            opacity: .5;
        }

        .todo-item button {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            border: 1px solid #ccc;
            background: white;
        }

        .todo-info {
            margin-top: 20px;
        }

    </style>
</head>
<body>

<div id="app"></div>

<script>

    const actions = {
        done(index) {
            const store = this.getStore('todo');
            store.record[index].done = !store.record[index].done;
        },

        add() {
            //console.log('add');
            const store = this.getStore('todo');
            if (store.todo) {
                store.record.push({
                    time: Date.now(),
                    title: store.todo,
                    done: false
                });
                store.todo = '';
            }
        },

        remove(index) {
            const store = this.getStore('todo');
            if (confirm(`Remove ${store.record[index].title}?`))
                store.record.splice(index, 1);
        },

        removeAll() {
            const store = this.getStore('todo');
            if (confirm(`Remove everything?`))
                store.record = [];
        },

        updateTotal() {
            const store = this.getStore('todo');
            let totalDone = 0;
            store.total = store.record.length;
            store.record.forEach(item => item.done ? totalDone++ : '');
            store.totalDone = totalDone;
        },

        showInput(e) {
            const text = e.target;
            const input = e.target.nextElementSibling;
            if (!input) return;
            input.style.display = 'inline';
            text.style.display = 'none';
            input.value = text.innerText;
            input.focus();
        },

        hideInput(index, e) {
            const input = e.target;
            const text = e.target.previousElementSibling;
            if (!text) return;
            input.style.display = 'none';
            text.style.display = 'inline';
            const store = this.getStore('todo');
            store.record[index].title = input.value;
        },

        inputEnterPress(index, e) {
            if (e.keyCode === 13) {
                this.action.hideInput(index, e);
            }
        },

        enterPress(e) {
            if (e.keyCode === 13) {
                this.action.add();
                e.target.value = '';
            }
        }
    };

    Doz.component('doz-todo-item', {
        template(h) {
            return h`
                <div class="todo-item ${this.props.done ? 'done' : ''} ">
                    <button onclick="console.log(this.internalId, this.props.title)" title="HTML">H</button>
                    <button onclick="this.destroy()" title="Delete">&cross;C</button>
                    <button onclick="this.action.remove(${this.props.id})" title="Delete">&cross;</button>
                    <button onclick="this.action.done(${this.props.id})" title="Done">&check;</button>
                    ${this.props.id} -
                    <span ondblclick="this.action.showInput()" style="${this.props.done ? 'text-decoration: line-through' : ''}">
                        <strong>${this.props.title}</strong>
                        <input
                            onblur="this.action.hideInput(${this.props.id})"
                            onkeypress="this.action.inputEnterPress(${this.props.id})"
                            style="display: none"
                            type="text"
                        >
                    </span>
                </div>
            `;
        },
        propsListener: {
            title(v, o) {
                //console.log('update from', o, 'to', v, 'uid', this.internalId)
            }
        },
        onUnmount() {
            console.log('UNMOUNT', this.internalId)
        },
        onDestroy() {
            console.log('DESTROY')
        }
    });

    Doz.component('doz-todo-buttons', {
        template(h) {
            return h`
                <button onclick="this.action.add()" >Add</button>
                <button onclick="this.action.removeAll()" >Remove all</button>
            `;
        }
    });
    Doz.component('x-update-man', {
        props: {
            index: 0,
            indexes: '',
            value: ''
        },
        template(h) {
            return h`
                <div>
                    index: <input d-bind="index" type="number"> value: <input d-bind="value" type="text"> <button onclick="this.update()">Update</button>
                </div>
                <div>
                    remove indexes: <input d-bind="indexes" type="text"> <button onclick="this.removeIndexes()">removeIndexes</button>
                </div>
                <div>
                    <button onclick="this.swap()">Swap</button>
                    <button onclick="this.reverse()">Reverse</button>
                    <button onclick="this.sort()">Sort</button>
                </div>
            `
        },
        update() {
            let record = Object.assign({}, this.getStore('todo').record[this.props.index]);
            record.title = this.props.value;
            this.getStore('todo').record[this.props.index] = record;

        },
        removeIndexes() {
            let record = Object.assign([], this.getStore('todo').record);
            this.props.indexes.split(',').forEach(i => {
                record.splice(i, 1);
            });
            this.getStore('todo').record = record;

        },
        swap() {
            if (!this.getStore('todo').record.length) return;
            let record = Object.assign([], this.getStore('todo').record);
            let i1 = Math.floor(Math.random()*record.length);
            let i2 = Math.floor(Math.random()*record.length);
            let tmp = record[i1];
            record[i1] = record[i2];
            record[i2] = tmp;
            this.getStore('todo').record = record;
        },
        reverse() {
            let record = Object.assign([], this.getStore('todo').record);
            this.getStore('todo').record = record.reverse();
        },

        sort() {
            let record = Object.assign([], this.getStore('todo').record);
            this.getStore('todo').record = record.sort();
        }
    });
    Doz.component('doz-todo', {
        store: 'todo',
        template(h) {
            return h`
                <div>
                    <div class="todo-input">
                        <input onkeypress="this.action.enterPress()" d-bind="todo" type="text" placeholder="Write a to-do">
                        <doz-todo-buttons></doz-todo-buttons>
                    </div>
                    <ul>
                    ${this.each(this.props.record, (item, i) =>
                        h`<li data-prefix="record" d-is="doz-todo-item" id="${i}" title="${item.title}" done="${item.done}"></li>`
                    )}
                    </ul>
                    <div class="todo-info">
                        Total: ${this.props.total} - Done: ${this.props.totalDone}
                    </div>
                </div>
            `;
        },

        props: {
            record: [],
            todo: '',
            total: 0,
            totalDone: 0
        },

        onMount() {
            this.props.record = JSON.parse(localStorage.getItem('doz-todo')) || [
                {title: "Buy milk", done: false},
                {title: "Buy cigarettes", done: false}
            ];
        },

        onUpdate(changes) {
            /*
            let candidateIndexToRemove;
            changes.forEach((change, i) => {
                console.log(change, i);
                if(Array.isArray(change.target)) {
                    //console.log(change, i);
                    if ((change.type === 'update' || change.type === 'delete') && candidateIndexToRemove === undefined) {
                        //console.log(change)
                        candidateIndexToRemove = change.property;
                    }
                }

            });

            console.log('candidateIndexToRemove', candidateIndexToRemove)

             */

            this.action.updateTotal();
            localStorage.setItem('doz-todo', JSON.stringify(this.props.record));
            /*setTimeout(()=>{
                Object.keys(this.children).forEach(key => {
                    if (this.children[key].tag !== 'doz-todo-item') return;
                    //console.log(this.children[key].props.title, this.children[key]);
                    if (!this.children[key].getHTMLElement().parentNode) {
                        console.log('non in DOM', this.children[key].internalId, this.children[key].props.title)
                    }
                })
            })*/

        }
    });

    new Doz({
        actions,
        root: document.getElementById('app'),
        template: `
            <h1>TO-DO list</h1>
            <x-update-man/>
            <doz-todo/>
        `
    });

</script>
</body>
</html>